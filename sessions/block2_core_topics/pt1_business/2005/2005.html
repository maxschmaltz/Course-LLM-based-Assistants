<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../../../../genindex.html" /><link rel="search" title="Search" href="../../../../search.html" /><link rel="next" title="Under development" href="../../pt2_science/under_development.html" /><link rel="prev" title="15.05. RAG Chatbot Pt. 1 📚" href="../1505/1505.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>20.05. RAG Chatbot Pt. 2 📚 - LLM-based Assistants</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../../index.html"><div class="brand">LLM-based Assistants</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../../index.html">
  
  
  <span class="sidebar-brand-text">LLM-based Assistants</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Infos and Stuff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../infos/topic_overview.html">Topics Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infos/formats/debates.html">Debates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infos/formats/pitches.html">Pitches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../infos/llm_inference_guide/README.html">LLM Inference Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Block 1: Intro</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../block1_intro/2204.html">22.04. LLMs as a Form of Intelligence vs LLMs as Statistical Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../block1_intro/2404.html">24.04. LLM &amp; Agent Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../block1_intro/2904/2904.html">29.04. Intro to LangChain 🦜🔗</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Block 2: Core Topics | Part 1: Business Applications</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../0605.html">06.05. Virtual Assistants Pt. 1: Chatbots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0805/0805.html">08.05. Basic LLM-based Chatbot 🤖</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1305.html">13.05. Virtual Assistants Pt. 2: RAG</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1505/1505.html">15.05. RAG Chatbot Pt. 1 📚</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">20.05. RAG Chatbot Pt. 2 📚</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Block 2: Core Topics | Part 2: Applications in Science</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pt2_science/under_development.html">Under development</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Block 3: Wrap-up</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../block3_wrapup/under_development.html">Under development</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="rag-chatbot-pt-2">
<h1>20.05. RAG Chatbot Pt. 2 📚<a class="headerlink" href="#rag-chatbot-pt-2" title="Link to this heading">¶</a></h1>
<p>📍 <a class="reference external" href="https://github.com/maxschmaltz/Course-LLM-based-Assistants/tree/main/llm-based-assistants/sessions/block2_core_topics/pt1_business/2005">Download notebook and session files</a></p>
<p>In today’l lab, we will complete our RAG chatbot and use the data we have preprocessed <a class="reference internal" href="../1505/1505.html"><span class="std std-doc">the last time</span></a> to inject our custom knowledge to the LLM.</p>
<p>Our plan for today:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#data"><span class="xref myst">Recap: Data Preprocessing</span></a></p></li>
<li><p><a class="reference internal" href="#rag"><span class="xref myst">Simple RAG</span></a></p></li>
<li><p><a class="reference internal" href="#adv_rag"><span class="xref myst">Advanced RAG</span></a></p></li>
</ul>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h2>
<p>To start with the tutorial, complete the steps <a class="reference internal" href="#../../../infos/llm_inference_guide/README.md#prerequisites"><span class="xref myst">Prerequisites</span></a>, <a class="reference internal" href="#../../../infos/llm_inference_guide/README.md#environment-setup"><span class="xref myst">Environment Setup</span></a>, and <a class="reference internal" href="#../../../infos/llm_inference_guide/README.md#getting-api-key"><span class="xref myst">Getting API Key</span></a> from the <a class="reference internal" href="#../../../infos/llm_inference_guide/README.md"><span class="xref myst">LLM Inference Guide</span></a>.</p>
<p>Today, we have more packages so we’ll use the requirements file to install the dependencies:
After that, you need to install a few more packages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>We will also reproduce the basic chatbot we implemented <a class="reference internal" href="../0805/0805.html"><span class="std std-doc">earlier</span></a> as the base for the future RAG Chatbot. The only difference will be that we now need a simpler state that only keeps track of the message history (the other fields were demonstrational).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">SystemMessage</span><span class="p">,</span> <span class="n">HumanMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_nvidia_ai_endpoints</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatNVIDIA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.rate_limiters</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryRateLimiter</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read system variables</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dotenv</span>

<span class="n">dotenv</span><span class="o">.</span><span class="n">load_dotenv</span><span class="p">()</span>    <span class="c1"># that loads the .env file variables into os.environ</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># choose any model, catalogue is available under https://build.nvidia.com/models</span>
<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="s2">&quot;meta/llama-3.3-70b-instruct&quot;</span>

<span class="c1"># this rate limiter will ensure we do not exceed the rate limit</span>
<span class="c1"># of 40 RPM given by NVIDIA</span>
<span class="n">rate_limiter</span> <span class="o">=</span> <span class="n">InMemoryRateLimiter</span><span class="p">(</span>
    <span class="n">requests_per_second</span><span class="o">=</span><span class="mi">30</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># 30 requests per minute to be sure</span>
    <span class="n">check_every_n_seconds</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># wake up every 100 ms to check whether allowed to make a request,</span>
    <span class="n">max_bucket_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># controls the maximum burst size</span>
<span class="p">)</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatNVIDIA</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">MODEL_NAME</span><span class="p">,</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NVIDIA_API_KEY&quot;</span><span class="p">),</span> 
    <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>   <span class="c1"># ensure reproducibility,</span>
    <span class="n">rate_limiter</span><span class="o">=</span><span class="n">rate_limiter</span>  <span class="c1"># bind the rate limiter</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">MermaidDrawMethod</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">nest_asyncio</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>  <span class="c1"># this is needed to draw the PNG in Jupyter</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="c1"># `messages` is a list of messages of any kind. The `add_messages` function</span>
    <span class="c1"># in the annotation defines how this state key should be updated</span>
    <span class="c1"># (in this case, it appends messages to the list, rather than overwriting them)</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span> <span class="n">add_messages</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Chatbot</span><span class="p">:</span>

    <span class="n">_graph_path</span> <span class="o">=</span> <span class="s2">&quot;./graph.png&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_graph</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># graph builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">SimpleState</span><span class="p">)</span>
        <span class="c1"># add the nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_respond_node</span><span class="p">)</span>
        <span class="c1"># define edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_quitting_node</span><span class="p">,</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="n">END</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="c1"># compile the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_input_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SimpleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">user_query</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Your message: &quot;</span><span class="p">)</span>
        <span class="n">human_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">user_query</span><span class="p">)</span>
        <span class="c1"># add the input to the messages</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">human_message</span>   <span class="c1"># this will append the input to the messages</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_respond_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SimpleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span>    <span class="c1"># will already contain the user query</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
        <span class="c1"># add the response to the messages</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">response</span>   <span class="c1"># this will append the response to the messages</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_quitting_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SimpleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># check if the user wants to quit</span>
        <span class="n">user_message</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>
        <span class="k">return</span> <span class="n">user_message</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;quit&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_display_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># unstable</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">(</span>
                <span class="n">draw_method</span><span class="o">=</span><span class="n">MermaidDrawMethod</span><span class="o">.</span><span class="n">PYPPETEER</span><span class="p">,</span>
                <span class="n">output_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_graph_path</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># add the run method</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">SystemMessage</span><span class="p">(</span>
                    <span class="n">content</span><span class="o">=</span><span class="s2">&quot;You are a helpful and honest assistant.&quot;</span> <span class="c1"># role</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>   <span class="c1">#stream_mode=&quot;updates&quot;):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<h2 id="data">1. Recap: Data Preprocessing 📕</h2>
<p>We will now go over data preprocessing to rehearse the workflow and also to recreate the data collection (we used an in-memory index, so the index we created the last time was deleted after we interrupted the notebook kernel).</p>
<p>Data preprocessing includes:</p>
<ol class="arabic simple">
<li><p>Loading: load the source (document, website etc.) as a text.</p></li>
<li><p>Chunking: chunk the loaded text onto smaller pieces.</p></li>
<li><p>Converting to embeddings: embed the chunks into dense vector for further similarity search.</p></li>
<li><p>Indexing: put the embeddings into a so-called index – a special database for efficient storage and search of vectors.</p></li>
</ol>
<section id="loading">
<h3>Loading<a class="headerlink" href="#loading" title="Link to this heading">¶</a></h3>
<p>We will take a PDF version of the Topic Overview for this course. No LLM can know the contents of it, especially some highly specific facts such as dates or key points.</p>
<p>One of ways to load a PDF is to use <a class="reference external" href="https://python.langchain.com/docs/integrations/document_loaders/pypdfloader/"><code class="docutils literal notranslate"><span class="pre">PyPDFLoader</span></code></a> that load simple textual PDFs and their metadata. In this tutorial, we focus on a simpler variant when there are no multimodal data in the PDF. You can find out more about advanced loading in tutorial <a class="reference external" href="https://python.langchain.com/docs/how_to/document_loader_pdf/">How to load PDFs</a> from LangChain.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.document_loaders</span><span class="w"> </span><span class="kn">import</span> <span class="n">PyPDFLoader</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">file_path</span> <span class="o">=</span> <span class="s2">&quot;./topic_overview.pdf&quot;</span>
<span class="n">loader</span> <span class="o">=</span> <span class="n">PyPDFLoader</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">async</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">loader</span><span class="o">.</span><span class="n">alazy_load</span><span class="p">():</span>
    <span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ignoring wrong pointing object 10 0 (offset 0)
Ignoring wrong pointing object 31 0 (offset 0)
</pre></div>
</div>
</div>
</div>
<p>This function returns a list of <code class="docutils literal notranslate"><span class="pre">Document</span></code> objects, each containing the text of the PDF and its metadata such as title, page, creation date etc.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pages</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 0, &#39;page_label&#39;: &#39;1&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 1 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nTo p i c s  O v e r v i e wThe schedule is preliminary and subject to changes!\nThe reading for each lecture is given as references to the sources the respective lectures base on. Youare not obliged to read anything. However, you are strongly encouraged to read references marked bypin emojis \n: those are comprehensive overviews on the topics or important works that are beneficialfor a better understanding of the key concepts. For the pinned papers, I also specify the pages span foryou to focus on the most important fragments. Some of the sources are also marked with a popcornemoji \n: that is misc material you might want to take a look at: blog posts, GitHub repos, leaderboardsetc. (also a couple of LLM-based games). For each of the sources, I also leave my subjectiveestimation of how important this work is for this specific topic: from yellow \n ‘partially useful’ thoughorange \n ‘useful’ to red \n ‘crucial findings / thoughts’.  T h e s e  e s t i m a t i o n s  w i l l  b e  c o n t i n u o u s l yupdated as I revise the materials.\nFor the labs, you are provided with practical tutorials that respective lab tasks will mostly derive from.The core tutorials are marked with a writing emoji \n; you are asked to inspect them in advance(better yet: try them out). On lab sessions, we will only briefly recap them so it is up to you to preparein advance to keep up with the lab.\nDisclaimer: the reading entries are no proper citations; the bibtex references as well as detailed infosabout the authors, publish date etc. can be found under the entry links.\nBlock 1: IntroWeek 122.04. Lecture: LLMs as a Form of Intelligence vs LLMs as Statistical MachinesThat is an introductory lecture, in which I will briefly introduce the course and we’ll have a warming updiscussion about different perspectives on LLMs’ nature. We will focus on two prominent outlooks: LLMis a form of intelligence and LLM is a complex statistical machine. We’ll discuss differences of LLMswith human intelligence and the degree to which LLMs exhibit (self-)awareness.\nKey points:\nCourse introduction\nDifferent perspectives on the nature of LLMs\nSimilarities and differences between human and artificial intelligence\nLLMs’ (self-)awareness\nCore Reading:\n The Debate Over Understanding in AI’s Large Language Models (pages 1-7), Santa Fe\nInstitute \nMeaning without reference in large language models, UC Berkeley &amp; DeepMind \nDissociating language and thought in large language models (intro [right after the abstract, seemore on the sectioning in this paper at the bottom of page 2], sections 1, 2.3 [LLMs are predictive…], 3-5), The University of Texas at Austin et al. \nAdditional Reading:\nLLM-basedAssistants\nINFOS AND STUFF\nBLOCK 1: INTRO\nBLOCK 2: CORE TOPICS | PART 1:BUSINESS APPLICATIONS\nBLOCK 2: CORE TOPICS | PART 2:APPLICATIONS IN SCIENCE\nBLOCK 3: WRAP-UP\nTopics Overview\nDebates\nPitches\nLLM Inference Guide\n22.04. LLMs as a Form ofIntelligence vs LLMs asStatistical Machines\n24.04. LLM &amp; Agent Basics\n29.04. Intro to LangChain \n!\n&quot;\n06.05. Virtual Assistants Pt. 1:Chatbots\n08.05. Basic LLM-basedChatbot \n#\nUnder development\nUnder development\nSearch&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 1, &#39;page_label&#39;: &#39;2&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 2 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nDo Large Language Models Understand Us?, Google Research \nSparks of Artificial General Intelligence: Early experiments with GPT-4 (chapters 1-8 &amp; 10),Microsoft Research \nOn the Dangers of Stochastic Parrots: Can Language Models Be Too Big? \n  (paragraphs 1, 5, 6.1),University of Washington et al. \nLarge Language Models: The Need for Nuance in Current Debates and a Pragmatic Perspective onUnderstanding, Leiden Institute of Advanced Computer Science &amp; Leiden University Medical\nCentre \n24.04. Lecture: LLM &amp; Agent BasicsIn this lecture, we’ll recap some basics about LLMs and LLM-based agents to make sure we’re on thesame page.\nKey points:\nLLM recap\nPrompting\nStructured output\nTool calling\nPiping &amp; Planning\nCore Reading:\nA Survey of Large Language Models, (sections 1, 2.1, 4.1, 4.2.1, 4.2.3-4.2.4, 4.3, 5.1.1-5.1.3, 5.2.1-5.2.4, 5.3.1, 6) Renmin University of China et al. \nEmergent Abilities of Large Language Models, Google Research, Stanford, UNC Chapel Hill,\nDeepMind\n“We Need Structured Output”: Towards User-centered Constraints on Large Language ModelOutput, Google Research &amp; Google\n Agent Instructs Large Language Models to be General Zero-Shot Reasoners (pages 1-9),Washington University &amp; UC Berkeley\nAdditional Reading:\nLanguage Models are Few-Shot Learners, OpenAI\nChain-of-Thought Prompting Elicits Reasoning in Large Language Models, Google Research\nThe Llama 3 Herd of Models, Meta AI\nIntroducing Structured Outputs in the API, OpenAI\nTool Learning with Large Language Models: A Survey, Renmin University of China et al.\nToolACE: Winning the Points of LLM Function Calling, Huawei Noah’s Ark Lab et al.\nToolformer: Language Models Can Teach Themselves to Use Tools, Meta AI\nGranite-Function Calling Model: Introducing Function Calling Abilities via Multi-task Learning ofGranular Tasks, IBM Research\n Berkeley Function-Calling Leaderboard, UC Berkeley (leaderboard)\nA Survey on Multimodal Large Language Models, University of Science and Technology of China\n&amp; Tencent YouTu Lab\nWeek 229.04. Lab: Intro to LangChainThe final introductory session will guide you through the most basic concepts of LangChain for thefurther practical sessions.&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 2, &#39;page_label&#39;: &#39;3&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 3 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nReading:\nRunnable interface, LangChain\nLangChain Expression Language (LCEL), LangChain\nMessages, LangChain\nChat models, LangChain\nStructured outputs, LangChain\nTools, LangChain\nTool calling, LangChain\n01.05.Ausfalltermin\nBlock 2: Core T opics\nPart 1: Business ApplicationsWeek 306.05. Lecture: Virtual Assistants Pt. 1: ChatbotsThe first core topic concerns chatbots. We’ll discuss how chatbots are built, how they (should) handleharmful requests and you can tune it for your use case.\nKey points:\nLLMs alignment\nMemory\nPrompting &amp; automated prompt generation\nEvaluation\nCore Reading:\n Aligning Large Language Models with Human: A Survey (pages 1-14), Huawei Noah’s Ark Lab\nSelf-Instruct: Aligning Language Models with Self-Generated Instructions, University of\nWashington et al.\nA Systematic Survey of Prompt Engineering in Large Language Models: Techniques andApplications, Indian Institute of Technology Patna, Stanford &amp; Amazon AI\nAdditional Reading:\nTraining language models to follow instructions with human feedback, OpenAI\nTraining a Helpful and Harmless Assistant with Reinforcement Learning from Human Feedback,Anthropic\nA Survey on the Memory Mechanism of Large Language Model based Agents, Renmin University\nof China &amp; Huawei Noah’s Ark Lab\nAugmenting Language Models with Long-Term Memory, UC Santa Barbara &amp; Microsoft Research\nFrom LLM to Conversational Agent: A Memory Enhanced Architecture with Fine-Tuning of LargeLanguage Models, Beike Inc.\nAutomatic Prompt Selection for Large Language Models, Cinnamon AI, Hung Yen University of\nTechnology and Education &amp; Deakin University\nPromptGen: Automatically Generate Prompts using Generative Models, Baidu Research\nEvaluating Large Language Models. A Comprehensive Survey, Tianjin University&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 3, &#39;page_label&#39;: &#39;4&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 4 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\n08.05. Lab: Basic LLM-based Chatbot\nOn material of session 06.05\nIn this lab, we’ll build a chatbot and try different prompts and settings to see how it affects the output.\nReading:\n Build a Chatbot, LangChain\n LangGraph Quickstart: Build a Basic Chatbot (parts 1, 3), LangGraph\n How to add summary of the conversation history, LangGraph\nPrompt Templates, LangChain\nFew-shot prompting, LangChain\nWeek 413.05. Lecture: Virtual Assistants Pt. 2: RAGContinuing the first part, the second part will expand scope of chatbot functionality and will teach it torefer to custom knowledge base to retrieve and use user-specific information. Finally, the most widelyused deployment methods will be briefly introduced.\nKey points:\nGeneral knowledge vs context\nKnowledge indexing, retrieval &amp; ranking\nRetrieval tools\nAgentic RAG\nCore Reading:\n Retrieval Augmented Generation or Long-Context LLMs? A Comprehensive Study and HybridApproach (pages 1-7), Google DeepMind &amp; University of Michigan \nA Survey on Retrieval-Augmented Text Generation for Large Language Models (sections 1-7), York\nUniversity \nAdditional Reading:\nDon’t Do RAG: When Cache-Augmented Generation is All You Need for Knowledge Tasks, National\nChengchi University &amp; Academia Sinica \nSelf-RAG: Learning to Retrieve, Generate, and Critique through Self-Reflection, University of\nWashington, Allen Institute for AI &amp; IBM Research AI\nAdaptive-RAG: Learning to Adapt Retrieval-Augmented Large Language Models through QuestionComplexity, Korea Advanced Institute of Science and Technology\nAuto-RAG: Autonomous Retrieval-Augmented Generation for Large Language Models, Chinese\nAcademy of Sciences\nQuerying Databases with Function Calling, Weaviate, Contextual AI &amp; Morningstar\n15.05. Lab: RAG Chatbot\nOn material of session 13.05\nIn this lab, we’ll expand the functionality of the chatbot built at the last lab to connect it to user-specificinformation.&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 4, &#39;page_label&#39;: &#39;5&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 5 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nReading:\nHow to load PDFs, LangChain\nText splitters, LangChain\nEmbedding models, LangChain\nVector stores, LangChain\nRetrievers, LangChain\n Retrieval augmented generation (RAG), LangChain\n LangGraph Quickstart: Build a Basic Chatbot (part 2), LangGraph\n Agentic RAG, LangGraph\nAdaptive RAG, LangGraph\nMultimodality, LangChain\nWeek 520.05. Lecture: Virtual Assistants Pt. 3: Multi-agent EnvironmentThis lectures concludes the Virtual Assistants cycle and directs its attention to automating everyday /business operations in a multi-agent environment. We’ll look at how agents communicate with eachother, how their communication can be guided (both with and without involvement of a human), andthis all is used in real applications.\nKey points:\nMulti-agent environment\nHuman in the loop\nLLMs as evaluators\nExamples of pipelines for business operations\nCore Reading:\n LLM-based Multi-Agent Systems: Techniques and Business Perspectives (pages 1-8), Shanghai\nJiao Tong University &amp; OPPO Research Institute\nGenerative Agents: Interactive Simulacra of Human Behavior, Stanford, Google Research &amp;\nDeepMind\nAdditional Reading:\nImproving Factuality and Reasoning in Language Models through Multiagent Debate, MIT &amp; Google\nBrain\nExploring Collaboration Mechanisms for LLM Agents: A Social Psychology View, Zhejiang\nUniversity, National University of Singapore &amp; DeepMind\nAutoGen: Enabling Next-Gen LLM Applications via Multi-Agent Conversation, Microsoft Research\net al.\n How real-world businesses are transforming with AI — with more than 140 new stories,Microsoft (blog post)\n Built with LangGraph, LangGraph (website page)\nPlan-Then-Execute: An Empirical Study of User Trust and Team Performance When Using LLMAgents As A Daily Assistant, Delft University of Technology &amp; The University of Queensland\n22.05. Lab: Multi-agent Environment\nOn material of session 20.05&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 5, &#39;page_label&#39;: &#39;6&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 6 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nThis lab will introduce a short walkthrough to creation of a multi-agent environment for automatedmeeting scheduling and preparation. We will see how the coordinator agent will communicate with twoauxiliary agents to check time availability and prepare an agenda for the meeting.\nReading:\n Multi-agent network, LangGraph\n Human-in-the-loop, LangGraph\nPlan-and-Execute, LangGraph\nReflection, LangGraph\n Multi-agent supervisor, LangGraph\nQuick Start, AutoGen\nWeek 627.05. Lecture: Software Development Pt. 1: Code Generation, Evaluation &amp;TestingThis lectures opens a new lecture mini-cycle dedicated to software development. The first lectureoverviews how LLMs are used to generate reliable code and how generated code is tested andimproved to deal with the errors.\nKey points:\nCode generation &amp; refining\nAutomated testing\nGenerated code evaluation\nCore Reading:\nLarge Language Model-Based Agents for Software Engineering: A Survey, Fudan University,\nNanyang Technological University &amp; University of Illinois at Urbana-Champaign\n CodeRL: Mastering Code Generation through Pretrained Models and Deep ReinforcementLearning (pages 1-20), Salesforce Research\nThe ART of LLM Refinement: Ask, Refine, and Trust, ETH Zurich &amp; Meta AI\nAdditional Reading:\nPlanning with Large Language Models for Code Generation, MIT-IBM Watson AI Lab et al.\nCode Repair with LLMs gives an Exploration-Exploitation Tradeoff, Cornell, Shanghai Jiao Tong\nUniversity &amp; University of Toronto\nChatUniTest: A Framework for LLM-Based Test Generation, Zhejiang University &amp; Hangzhou City\nUniversity\nTestART: Improving LLM-based Unit Testing via Co-evolution of Automated Generation and RepairIteration, Nanjing University &amp; Huawei Cloud Computing Technologies\nEvaluating Large Language Models Trained on Code, `OpenAI\n Code Generation on HumanEval, OpenAI (leaderboard)\nCodeJudge: Evaluating Code Generation with Large Language Models, Huazhong University of\nScience and Technology &amp; Purdue University\n29.05.Ausfalltermin&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 6, &#39;page_label&#39;: &#39;7&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 7 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nWeek 703.06. Lecture: Software Development Pt. 2: Copilots, LLM-powered WebsitesThe second and the last lecture of the software development cycle focuses on practical application ofLLM code generation, in particular, on widely-used copilots (real-time code generation assistants) andLLM-supported web development.\nKey points:\nCopilots &amp; real-time hints\nLLM-powered websites\nLLM-supported deployment\nFurther considerations: reliability, sustainability etc.\nCore Reading:\n LLMs in Web Development: Evaluating LLM-Generated PHP Code Unveiling Vulnerabilities andLimitations (pages 1-11), University of Oslo\nA Real-World WebAgent with Planning, Long Context Understanding, and Program Synthesis,Google DeepMind &amp; The University of Tokyo\nCan ChatGPT replace StackOverflow? A Study on Robustness and Reliability of Large LanguageModel Code Generation, UC San Diego\nAdditional Reading:\nDesign and evaluation of AI copilots – case studies of retail copilot templates, Microsoft\n Your AI Companion, Microsoft (blog post)\nGitHub Copilot, GitHub (product page)\n Research: quantifying GitHub Copilot’s impact on developer productivity and happiness, GitHub\n(blog post)\n Cursor: The AI Code Editor, Cursor (product page)\nAutomated Unit Test Improvement using Large Language Models at Meta, Meta\nHuman-In-the-Loop Software Development Agents, Monash University, The University of\nMelbourne &amp; Atlassian\nAn LLM-based Agent for Reliable Docker Environment Configuration, Harbin Institute of\nTechnology &amp; ByteDance\nLearn to Code Sustainably: An Empirical Study on LLM-based Green Code Generation, TWT GmbH\nScience &amp; Innovation et al.\nEnhancing Large Language Models for Secure Code Generation: A Dataset-driven Study onVulnerability Mitigation, South China University of Technology &amp; University of Innsbruck\n05.06 Lab: LLM-powered Website\nOn material of session 03.06\nIn this lab, we’ll have the LLM make a website for us: it will both generate the contents of the websiteand generate all the code required for rendering, styling and navigation.\nReading:\nsee session 22.05\n HTML: Creating the content, MDN\n Getting started with CSS, MDN&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 7, &#39;page_label&#39;: &#39;8&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 8 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nWeek 8: Having Some Rest10.06.Ausfalltermin\n12.06.Ausfalltermin\nWeek 917.06. Pitch: RAG Chatbot\nOn material of session 06.05 and session 13.05\nThe first pitch will be dedicated to a custom RAG chatbot that the contractors (the presentingstudents, see the infos about Pitches) will have prepared to present. The RAG chatbot will have to beable to retrieve specific information from the given documents (not from the general knowledge!) anduse it in its responses. Specific requirements will be released on 22.05.\nReading: see session 06.05, session 08.05, session 13.05, and session 15.05\n19.06.Ausfalltermin\nWeek 1024.06. Pitch: Handling Customer Requests in a Multi-agent Environment\nOn material of session 20.05\nIn the second pitch, the contractors will present their solution to automated handling of customerrequests. The solution will have to introduce a multi-agent environment to take off working load froman imagined support team. The solution will have to read and categorize tickets, generate replies and(in case of need) notify the human that their interference is required. Specific requirements will bereleased on 27.05.\nReading: see session 20.05 and session 22.05\n26.06. Lecture: Other Business Applications: Game Design, Financial Analysisetc.This lecture will serve a small break and will briefly go over other business scenarios that the LLMs areused in.\nKey points:\nGame design &amp; narrative games\nFinancial applications\nContent creation\nAdditional Reading:&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 8, &#39;page_label&#39;: &#39;9&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 9 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nPlayer-Driven Emergence in LLM-Driven Game Narrative, Microsoft Research\nGenerating Converging Narratives for Games with Large Language Models, U.S. Army Research\nLaboratory\nGame Agent Driven by Free-Form Text Command: Using LLM-based Code Generation and BehaviorBranch, University of Tokyo\n AI Dungeon Games, AI Dungeon (game catalogue)\n AI Town, Andreessen Horowitz &amp; Convex (game)\nIntroducing NPC-Playground, a 3D playground to interact with LLM-powered NPCs, HuggingFace\n(blog post)\nBlip, bliporg (GitHub repo)\ngigax, GigaxGames (GitHub repo)\nLarge Language Models in Finance: A Survey, Columbia &amp; New York University\nFinLlama: Financial Sentiment Classification for Algorithmic Trading Applications, Imperial College\nLondon &amp; MIT\nEquipping Language Models with Tool Use Capability for Tabular Data Analysis in Finance, Monash\nUniversity\nLLM4EDA: Emerging Progress in Large Language Models for Electronic Design Automation,Shanghai Jiao Tong University et al.\nAssisting in Writing Wikipedia-like Articles From Scratch with Large Language Models, Stanford\nLarge Language Models Can Solve Real-World Planning Rigorously with Formal Verification Tools,MIT, Harvard University &amp; MIT-IBM Watson AI Lab\nPart 2: Applications in ScienceWeek 1101.07. Lecture: LLMs in Research: Experiment Planning &amp; HypothesisGenerationThe first lecture dedicated to scientific applications shows how LLMs are used to plan experiments andgenerate hypothesis to accelerate research.\nKey points:\nExperiment planning\nHypothesis generation\nPredicting possible results\nCore Reading:\n Hypothesis Generation with Large Language Models (pages 1-9), University of Chicago &amp;\nToyota Technological Institute at Chicago\n LLMs for Science: Usage for Code Generation and Data Analysis (pages 1-6), TUM\nEmergent autonomous scientific research capabilities of large language models, Carnegie Mellon\nUniversity\nAdditional Reading:&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 9, &#39;page_label&#39;: &#39;10&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 10 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nImproving Scientific Hypothesis Generation with Knowledge Grounded Large Language Models,University of Virginia\nPaper Copilot: A Self-Evolving and Efficient LLM System for Personalized Academic Assistance,University of Illinois at Urbana-Champaign, Carnegie Mellon University &amp; Carleton College\nSciLitLLM: How to Adapt LLMs for Scientific Literature Understanding, University of Science and\nTechnology of China &amp; DP Technology\nMapping the Increasing Use of LLMs in Scientific Papers, Stanford\n03.07: Lab: Experiment Planning &amp; Hypothesis Generation\nOn material of session 01.07\nIn this lab, we’ll practice in facilitating researcher’s work with LLMs on the example of a toy scientificresearch.\nReading: see session 22.05\nWeek 1208.07: Pitch: Agent for Code Generation\nOn material of session 27.05\nThis pitch will revolve around the contractors’ implementation of a self-improving code generator. Thecode generator will have to generate both scripts and test cases for a problem given in the inputprompt, run the tests and refine the code if needed. Specific requirements will be released on 17.06.\nReading: see session 27.05 and session 05.06\n10.07. Lecture: Other Applications in Science: Drug Discovery, Math etc. &amp;Scientific ReliabilityThe final core topic will mention other scientific applications of LLMs that were not covered in theprevious lectures and address the question of reliability of the results obtained with LLMs.\nKey points:\nDrug discovery, math &amp; other applications\nScientific confidence &amp; reliability\nCore Reading:\n Can LLMs replace Neil deGrasse Tyson? Evaluating the Reliability of LLMs as ScienceCommunicators (pages 1-9), Indian Institute of Technology\nAdditional Reading:&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 10, &#39;page_label&#39;: &#39;11&#39;}, page_content=&#39;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 11 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nA Comprehensive Survey of Scientific Large Language Models and Their Applications in ScientificDiscovery, University of Illinois at Urbana-Champaign et al.\nLarge Language Models in Drug Discovery and Development: From Disease Mechanisms to ClinicalTrials, Department of Data Science and AI, Monash University et al.\nLLM-SR: Scientific Equation Discovery via Programming with Large Language Models, Virginia\nTech et al.\n Awesome Scientific Language Models, yuzhimanhua (GitHub repo)\nCURIE: Evaluating LLMs On Multitask Scientific Long Context Understanding and Reasoning, Google\net al.\nMultiple Choice Questions: Reasoning Makes Large Language Models (LLMs) More Self-ConfidentEven When They Are Wrong, Nanjing University of Aeronautics and Astronautics et al.\nBlock 3: Wrap-upWeek 1315.07. Pitch: Agent for Web Development\nOn material of session 03.06\nThe contractors will present their agent that will have to generate full (minimalistic) websites by aprompt. For each website, the agent will have to generate its own style and a simple menu with workingnavigation as well as the contents. Specific requirements will be released on 24.06.\nReading: see session 03.06 and session 05.06\n17.07. Lecture: Role of AI in Recent YearsThe last lecture of the course will turn to societal considerations regarding LLMs and AI in general andwill investigate its role and influence on the humanity nowadays.\nKey points:\nStudies on influence of AI in the recent years\nStudies on AI integration rate\nEthical, legal &amp; environmental aspects\nCore Reading:\n Protecting Human Cognition in the Age of AI (pages 1-5), The University of Texas at Austin et al.\n Artificial intelligence governance: Ethical considerations and implications for social responsibility(pages 1-12), University of Malta\nAdditional Reading:&#39;),
 Document(metadata={&#39;producer&#39;: &#39;macOS Version 12.7.6 (Build 21H1320) Quartz PDFContext&#39;, &#39;creator&#39;: &#39;Safari&#39;, &#39;creationdate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;title&#39;: &#39;Topics Overview - LLM-based Assistants&#39;, &#39;moddate&#39;: &quot;D:20250512152829Z00&#39;00&#39;&quot;, &#39;source&#39;: &#39;./topic_overview.pdf&#39;, &#39;total_pages&#39;: 12, &#39;page&#39;: 11, &#39;page_label&#39;: &#39;12&#39;}, page_content=&quot;12.05.25, 17:28Topics Overview - LLM-based Assistants\nPage 12 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html\nAugmenting Minds or Automating Skills: The Differential Role of Human Capital in Generative AI’sImpact on Creative Tasks, Tsinghua University &amp; Wuhan University of Technology\nHuman Creativity in the Age of LLMs: Randomized Experiments on Divergent and ConvergentThinking, University of Toronto\nEmpirical evidence of Large Language Model’s influence on human spoken communication, Max-\nPlanck Institute for Human Development\n The 2025 AI Index Report: Top Takeaways, Stanford\nGrowing Up: Navigating Generative AI’s Early Years – AI Adoption Report: Executive Summary, AI at\nWharton\nEthical Implications of AI in Data Collection: Balancing Innovation with Privacy, AI Data Chronicles\nLegal and ethical implications of AI-based crowd analysis: the AI Act and beyond, Vrije\nUniversiteit\nA Survey of Sustainability in Large Language Models: Applications, Economics, and Challenges,Cleveland State University et al.\nWeek 1422.07. Pitch: LLM-based Research Assistant\nOn material of session 01.07\nThe last pitch will introduce an agent that will have to plan the research, generate hypotheses, find theliterature etc. for a given scientific problem. It will then have to introduce its results in form of a TODOor a guide for the researcher to start off of. Specific requirements will be released on 01.07.\nReading: see session 01.07 and session 03.07\n24.07. Debate: Role of AI in Recent Years + Wrap-up\nOn material of session 17.07\nThe course will be concluded by the final debates, after which a short Q&amp;A session will be held.\nDebate topics:\nLLM Behavior: Evidence of Awareness or Illusion of Understanding?\nShould We Limit the Usage of AI?\nReading: see session 17.07\nCopyright © 2025, Maksim ShmaltsMade with Sphinx and @pradyunsg&#39;s Furo&quot;)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 1 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
To p i c s  O v e r v i e wThe schedule is preliminary and subject to changes!
The reading for each lecture is given as references to the sources the respective lectures base on. Youare not obliged to read anything. However, you are strongly encouraged to read references marked bypin emojis 
: those are comprehensive overviews on the topics or important works that are beneficialfor a better understanding of the key concepts. For the pinned papers, I also specify the pages span foryou to focus on the most important fragments. Some of the sources are also marked with a popcornemoji 
: that is misc material you might want to take a look at: blog posts, GitHub repos, leaderboardsetc. (also a couple of LLM-based games). For each of the sources, I also leave my subjectiveestimation of how important this work is for this specific topic: from yellow 
 ‘partially useful’ thoughorange 
 ‘useful’ to red 
 ‘crucial findings / thoughts’.  T h e s e  e s t i m a t i o n s  w i l l  b e  c o n t i n u o u s l yupdated as I revise the materials.
For the labs, you are provided with practical tutorials that respective lab tasks will mostly derive from.The core tutorials are marked with a writing emoji 
; you are asked to inspect them in advance(better yet: try them out). On lab sessions, we will only briefly recap them so it is up to you to preparein advance to keep up with the lab.
Disclaimer: the reading entries are no proper citations; the bibtex references as well as detailed infosabout the authors, publish date etc. can be found under the entry links.
Block 1: IntroWeek 122.04. Lecture: LLMs as a Form of Intelligence vs LLMs as Statistical MachinesThat is an introductory lecture, in which I will briefly introduce the course and we’ll have a warming updiscussion about different perspectives on LLMs’ nature. We will focus on two prominent outlooks: LLMis a form of intelligence and LLM is a complex statistical machine. We’ll discuss differences of LLMswith human intelligence and the degree to which LLMs exhibit (self-)awareness.
Key points:
Course introduction
Different perspectives on the nature of LLMs
Similarities and differences between human and artificial intelligence
LLMs’ (self-)awareness
Core Reading:
 The Debate Over Understanding in AI’s Large Language Models (pages 1-7), Santa Fe
Institute 
Meaning without reference in large language models, UC Berkeley &amp; DeepMind 
Dissociating language and thought in large language models (intro [right after the abstract, seemore on the sectioning in this paper at the bottom of page 2], sections 1, 2.3 [LLMs are predictive…], 3-5), The University of Texas at Austin et al. 
Additional Reading:
LLM-basedAssistants
INFOS AND STUFF
BLOCK 1: INTRO
BLOCK 2: CORE TOPICS | PART 1:BUSINESS APPLICATIONS
BLOCK 2: CORE TOPICS | PART 2:APPLICATIONS IN SCIENCE
BLOCK 3: WRAP-UP
Topics Overview
Debates
Pitches
LLM Inference Guide
22.04. LLMs as a Form ofIntelligence vs LLMs asStatistical Machines
24.04. LLM &amp; Agent Basics
29.04. Intro to LangChain 
!
&quot;
06.05. Virtual Assistants Pt. 1:Chatbots
08.05. Basic LLM-basedChatbot 
#
Under development
Under development
Search
</pre></div>
</div>
</div>
</div>
<p>As you can see, the result is not satisfying because the PDF has a more complex structure than just one-paragraph text. To handle it’s layout, we could use <code class="docutils literal notranslate"><span class="pre">UnstructuredLoader</span></code> that will return a <code class="docutils literal notranslate"><span class="pre">Document</span></code> not for the whole page but for a single structure; for simplicity, let’s now go with <code class="docutils literal notranslate"><span class="pre">PyPDF</span></code>.</p>
</section>
<section id="chunking">
<h3>Chunking<a class="headerlink" href="#chunking" title="Link to this heading">¶</a></h3>
<p>During RAG, relevant documents are usually retrieved by semantic similarity that is calculated between the search query and each document in the index. However, if we calculate vectors for the entire PDF pages, we risk not to capture any meaning in the embedding because the context is just too long. That is why usually, loaded text is <em>chunked</em> in a RAG application; embeddings for smaller pieces of text are more discriminative, and thus the relevant context may be retrieved better. Furthermore, it ensure process consistency when working documents of varying sizes, and is just more computationally efficient.</p>
<p>Different approaches to chunking are described in tutorial <a class="reference external" href="https://python.langchain.com/docs/concepts/text_splitters/">Text splitters</a> from LangChain. We’ll use <code class="docutils literal notranslate"><span class="pre">RecursiveCharacterTextSplitter</span></code> – a good option in terms of simplicity-quality ratio for simple cases. This splitter tries to keep text structures (paragraphs, sentences) together and thus maintain text coherence in chunks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_text_splitters</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.documents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span>
    <span class="n">chunk_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="c1"># maximum number of characters in a chunk</span>
    <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">50</span> <span class="c1"># number of characters to overlap between chunks</span>
<span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">split_page</span><span class="p">(</span><span class="n">page</span><span class="p">:</span> <span class="n">Document</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">text_splitter</span><span class="o">.</span><span class="n">split_text</span><span class="p">(</span><span class="n">page</span><span class="o">.</span><span class="n">page_content</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">Document</span><span class="p">(</span>
            <span class="n">page_content</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">)</span> 
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
    <span class="n">docs</span> <span class="o">+=</span> <span class="n">split_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span><span class="si">}</span><span class="s2"> pages into </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span><span class="si">}</span><span class="s2"> chunks.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Converted 12 pages into 66 chunks.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">docs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>For the labs, you are provided with practical tutorials that respective lab tasks will mostly derive from.The core tutorials are marked with a writing emoji 
; you are asked to inspect them in advance(better yet: try them out). On lab sessions, we will only briefly recap them so it is up to you to preparein advance to keep up with the lab.
</pre></div>
</div>
</div>
</div>
</section>
<section id="convert-to-embeddings">
<h3>Convert to Embeddings<a class="headerlink" href="#convert-to-embeddings" title="Link to this heading">¶</a></h3>
<p>As discussed, the retrieval usually succeeds by vector similarity and the index contains not the actual texts but their vector representations. Vector representations are created by <em>embedding models</em> – models usually made specifically for this objective by being trained to create more similar vectors for more similar sentences and to push apart dissimilar sentences in the vector space.</p>
<p>In the last session, we used the <a class="reference external" href="https://build.nvidia.com/nvidia/nv-embedqa-e5-v5?snippet_tab=LangChain"><code class="docutils literal notranslate"><span class="pre">nv-embedqa-e5-v5</span></code></a> model – a model from NVIDIA pretrained for English QA. However, their didn’t work very stable, so in this session, we’ll substitute them with <a class="reference external" href="https://huggingface.co/sentence-transformers">HF Sentence Transformers Embeddings</a>: an open-source lightweight alternative that runs <strong>locally</strong>. However, the choice of the model here also heavily depends on the use case; for example, the model we will be using – <a class="reference external" href="https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2"><code class="docutils literal notranslate"><span class="pre">all-MiniLM-L6-v2</span></code></a> – truncates input text longer than 256 word pieces by default, which is fine for our short passages but may be critical in other applications.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_huggingface</span><span class="w"> </span><span class="kn">import</span> <span class="n">HuggingFaceEmbeddings</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EMBEDDING_NAME</span> <span class="o">=</span> <span class="s2">&quot;all-MiniLM-L6-v2&quot;</span>

<span class="n">embeddings</span> <span class="o">=</span> <span class="n">HuggingFaceEmbeddings</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">EMBEDDING_NAME</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>An embedding model receives an input text and returns a dense vector that is believed to capture its semantic properties.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_embedding</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="s2">&quot;Sample sentence to embed&quot;</span><span class="p">)</span>
<span class="n">test_embedding</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.011639527976512909,
 0.03718038275837898,
 0.04311547055840492,
 0.02063680626451969,
 0.07240589708089828,
 0.07042297720909119,
 0.0722837969660759,
 0.0378093384206295,
 -0.008180405013263226,
 -0.04879167675971985,
 0.03116217814385891,
 -0.06400202214717865,
 0.046021148562431335,
 -0.007063554134219885,
 0.022139178588986397,
 0.0818285197019577,
 0.09043239802122116,
 0.062112849205732346,
 -0.053189489990472794,
 -0.052397601306438446,
 -0.0065028793178498745,
 0.02124064415693283,
 0.07372233271598816,
 -0.04451997950673103,
 0.0008839594083838165,
 0.008147072978317738,
 0.024836406111717224,
 0.07420461624860764,
 0.09315934777259827,
 -0.012337173335254192,
 0.02154213935136795,
 -0.05823332443833351,
 0.013287056237459183,
 0.03655413165688515,
 0.08775939047336578,
 0.037879034876823425,
 -0.012672808021306992,
 0.026031101122498512,
 -0.011200224049389362,
 0.03390206769108772,
 0.012480386532843113,
 0.0007153262849897146,
 0.036123938858509064,
 0.03519579395651817,
 0.047758299857378006,
 -0.08590920269489288,
 -0.04159936308860779,
 -0.003877071663737297,
 -0.007894373498857021,
 0.048365525901317596,
 -0.06638959050178528,
 -0.032844867557287216,
 -0.06834123283624649,
 -0.04104126617312431,
 -0.028998278081417084,
 -0.03925301134586334,
 -0.032819122076034546,
 -0.030211985111236572,
 0.02564634382724762,
 -0.07260775566101074,
 0.02827909030020237,
 -0.036977075040340424,
 0.007452061399817467,
 0.027809590101242065,
 0.05267297104001045,
 -0.07021653652191162,
 -0.014117561280727386,
 0.06044849753379822,
 -0.04571892321109772,
 0.08376257121562958,
 -0.04840059578418732,
 0.029129421338438988,
 -0.09749414771795273,
 0.000840750930365175,
 -0.1273718923330307,
 0.004639281891286373,
 -0.00298058008775115,
 -0.09776831418275833,
 0.11727699637413025,
 -0.04606999084353447,
 0.003772728843614459,
 -0.09066886454820633,
 -0.017231985926628113,
 0.015924569219350815,
 0.05297653749585152,
 -0.0007727170013822615,
 0.07499522715806961,
 -0.041528407484292984,
 -0.0814230814576149,
 0.014081133529543877,
 -0.0240975022315979,
 -0.04162980616092682,
 0.00716903293505311,
 0.0013181520625948906,
 0.012083918787539005,
 0.031722135841846466,
 -0.0793284997344017,
 -0.06150233745574951,
 0.04770230874419212,
 0.12866610288619995,
 0.026449069380760193,
 0.0762377679347992,
 0.04883785545825958,
 -0.019133100286126137,
 -0.14779499173164368,
 -0.102051742374897,
 -0.024965208023786545,
 -0.017843855544924736,
 -0.012672643177211285,
 -0.037501152604818344,
 -0.039078135043382645,
 0.00882380735129118,
 -0.008173207752406597,
 0.0051508317701518536,
 0.044090498238801956,
 -0.0769847184419632,
 0.03186015412211418,
 -0.04060757905244827,
 -0.0226266048848629,
 -0.03339717164635658,
 0.011200472712516785,
 0.085564523935318,
 -0.0837293490767479,
 0.02627517096698284,
 -0.013925299979746342,
 -0.07439687103033066,
 0.10562660545110703,
 -2.4493996193274784e-33,
 0.0031094704754650593,
 -0.047185227274894714,
 0.01799844391644001,
 0.04524950683116913,
 0.04918197914958,
 0.039841923862695694,
 -0.044148094952106476,
 0.10661552101373672,
 -0.11884736269712448,
 0.04877129942178726,
 -0.02893945388495922,
 -0.08021640032529831,
 0.04146934673190117,
 0.07287456095218658,
 -0.01529389526695013,
 -0.004749467596411705,
 -0.03762802854180336,
 0.0033071800135076046,
 0.00937844067811966,
 0.038330044597387314,
 -0.0219061728566885,
 0.041894685477018356,
 -0.03569726645946503,
 -0.03526904806494713,
 -0.08044841140508652,
 -0.04604843258857727,
 0.051873579621315,
 -0.04847503826022148,
 -0.04698622599244118,
 0.006474812515079975,
 -0.0704488456249237,
 -0.07238122820854187,
 -0.01255940180271864,
 -0.005925860721617937,
 0.06142212450504303,
 0.011619224213063717,
 0.06381605565547943,
 0.030987877398729324,
 0.001669619814492762,
 0.007098140195012093,
 0.05251732096076012,
 -0.018041789531707764,
 0.09164673835039139,
 0.0024327959399670362,
 -0.027754290029406548,
 0.0033376712817698717,
 0.05222579836845398,
 0.019585059955716133,
 0.024918364360928535,
 -0.011664268560707569,
 0.017139572650194168,
 0.027144303545355797,
 -0.021466337144374847,
 -0.05664077773690224,
 0.12554022669792175,
 0.003554984461516142,
 -0.06615206599235535,
 0.07275242358446121,
 0.07055477797985077,
 0.006175174377858639,
 -0.006075164768844843,
 0.021315935999155045,
 0.01410683710128069,
 0.0329328253865242,
 0.0382511280477047,
 0.022879602387547493,
 -0.028423108160495758,
 -0.08140161633491516,
 0.0870395377278328,
 0.0505465492606163,
 -0.03160814195871353,
 0.0065881903283298016,
 -0.10739683359861374,
 -0.01242506317794323,
 -0.09637781232595444,
 0.019851822406053543,
 -0.04090028256177902,
 0.009808083064854145,
 -0.006711379624903202,
 0.043482959270477295,
 -0.006808578036725521,
 -0.12525717914104462,
 -0.02061653882265091,
 -0.015587188303470612,
 -0.005075118504464626,
 -0.06577302515506744,
 0.032940931618213654,
 -0.12829968333244324,
 0.05006210133433342,
 0.012256840243935585,
 -0.02283720299601555,
 -0.026797786355018616,
 -0.021386586129665375,
 -0.021436093375086784,
 0.08388675004243851,
 5.211621359077177e-35,
 0.0005258721648715436,
 0.046621229499578476,
 0.006997690536081791,
 0.013881109654903412,
 0.040527183562517166,
 0.01623893529176712,
 -0.04276292398571968,
 0.006987962406128645,
 -0.012187881395220757,
 0.06422524899244308,
 -0.05008508265018463,
 -0.041584353893995285,
 0.09634178131818771,
 -0.08871810138225555,
 0.00872135628014803,
 0.07772611826658249,
 0.011686037294566631,
 0.02889171801507473,
 -0.040531404316425323,
 0.06143515557050705,
 -0.037673596292734146,
 0.04913065955042839,
 0.025919627398252487,
 0.07578086853027344,
 0.047935307025909424,
 0.0919497087597847,
 0.054394032806158066,
 -0.04059455171227455,
 -0.0671158954501152,
 -0.06804458051919937,
 -0.02733440138399601,
 -0.10623344033956528,
 -0.030151473358273506,
 0.03647211194038391,
 -0.06721152365207672,
 0.031662244349718094,
 0.13135188817977905,
 -0.018756119534373283,
 -0.04304072633385658,
 -0.0013509135460481048,
 0.08837597072124481,
 0.014184346422553062,
 -0.08203218877315521,
 0.04725467413663864,
 0.00427491869777441,
 -0.01842138171195984,
 -0.11865165829658508,
 -0.0676911398768425,
 0.08061803877353668,
 0.025813885033130646,
 -0.13013888895511627,
 0.018252849578857422,
 -0.10066743940114975,
 -0.013041422702372074,
 0.009973641484975815,
 -0.07359949499368668,
 -0.002750976476818323,
 -0.05379823222756386,
 0.029658259823918343,
 -0.022493738681077957,
 -0.04210195317864418,
 0.023892607539892197,
 -0.019984591752290726,
 -0.08516755700111389,
 0.12846815586090088,
 -0.1019839495420456,
 -0.030387867242097855,
 0.0486404187977314,
 -0.0792829617857933,
 -0.03330032899975777,
 -0.01742643676698208,
 0.011735490523278713,
 -0.017735393717885017,
 0.006592880934476852,
 -0.027418501675128937,
 -0.022646907716989517,
 0.051702581346035004,
 0.0038727924693375826,
 -0.025406453758478165,
 -0.10005642473697662,
 0.06624273955821991,
 -0.04884424805641174,
 0.028326215222477913,
 -0.03656398504972458,
 0.021011028438806534,
 0.038866762071847916,
 0.016526609659194946,
 -0.04571989178657532,
 -0.028324227780103683,
 0.052568189799785614,
 -0.01536584459245205,
 0.00510788056999445,
 0.016185052692890167,
 0.05604090914130211,
 0.05189011991024017,
 -1.5948948828281573e-08,
 -0.022652175277471542,
 0.015237188898026943,
 0.04294353723526001,
 0.012781250290572643,
 -0.049484968185424805,
 -0.02242325432598591,
 0.00895726028829813,
 -0.05432410165667534,
 -0.032178182154893875,
 -0.04800733923912048,
 0.0511842705309391,
 -0.03152543306350708,
 -0.023740721866488457,
 0.0015811433549970388,
 -0.006890567950904369,
 0.05231360346078873,
 -0.059246860444545746,
 0.006429159082472324,
 0.019715072587132454,
 0.0300996545702219,
 0.030963828787207603,
 0.085995152592659,
 -0.006611308548599482,
 0.0017660981975495815,
 -0.04612205550074577,
 0.015180149115622044,
 0.011716002598404884,
 0.007977939210832119,
 0.03837024047970772,
 0.02290923520922661,
 0.027564091607928276,
 0.09625943750143051,
 -0.023623675107955933,
 -0.03365515172481537,
 -0.017337143421173096,
 -0.04669130966067314,
 0.03919530287384987,
 -0.09497537463903427,
 0.009154191240668297,
 -0.06500634551048279,
 -0.002274857135489583,
 0.030338486656546593,
 -0.059148985892534256,
 -0.032823238521814346,
 0.09640981256961823,
 -0.0010113314492627978,
 0.02114374376833439,
 -0.04600390046834946,
 0.018581993877887726,
 0.016355210915207863,
 -0.026192156597971916,
 -0.07646306604146957,
 0.023274291306734085,
 -0.02331104502081871,
 0.0356781966984272,
 0.04583622142672539,
 0.031159117817878723,
 0.012169982306659222,
 -0.026043405756354332,
 0.00952734611928463,
 0.025545505806803703,
 0.0908745601773262,
 0.013599500060081482,
 -0.06861294060945511]
</pre></div>
</div>
</div>
</div>
</section>
<section id="indexing">
<h3>Indexing<a class="headerlink" href="#indexing" title="Link to this heading">¶</a></h3>
<p>Now that we have split our data and initialized the embeddings, we can start indexing it. There are a lot of different implementations of indexes, you can take a lot at available options in <a class="reference external" href="https://python.langchain.com/docs/integrations/vectorstores/">Vector stores</a>. One of the popular choices is <a class="reference external" href="https://python.langchain.com/docs/integrations/vectorstores/qdrant/">Qdrant</a> that provides a simple data management and can be deployed both locally, on a remote machine, and on the cloud.</p>
<p>Qdrant support persisting your vector storage, i.e. storing it on the working machine, but for simplicity, we will use it in the in-memory mode, so that the storage exists only as long as the notebook does.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_qdrant</span><span class="w"> </span><span class="kn">import</span> <span class="n">QdrantVectorStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qdrant_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">QdrantClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qdrant_client.http.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Distance</span><span class="p">,</span> <span class="n">VectorParams</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid4</span>
</pre></div>
</div>
</div>
</div>
<p>First things first, we need to create a <em>client</em> – a Qdrant instance that will be the entrypoint for all the actions we do with the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qd_client</span> <span class="o">=</span> <span class="n">QdrantClient</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>    <span class="c1"># in-memory Qdrant client</span>
</pre></div>
</div>
</div>
</div>
<p>Then, as we use an in-memory client that does not store the index between the notebook sessions, we need to initialize a <em>collection</em>. Alternatively, if we were persisting the data, we would perform a check if the collection exists and then either create or load it.</p>
<p>For Qdrant to initialize the structure of the index correctly, we need to provide the dimentionality of the embedding we will be using as well as teh distance metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&quot;2005&quot;</span>

<span class="n">qd_client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
    <span class="c1"># embedding params here</span>
    <span class="n">vectors_config</span><span class="o">=</span><span class="n">VectorParams</span><span class="p">(</span>
        <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test_embedding</span><span class="p">),</span>   <span class="c1"># is there a better way?</span>
        <span class="n">distance</span><span class="o">=</span><span class="n">Distance</span><span class="o">.</span><span class="n">COSINE</span>    <span class="c1"># cosine distance</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>Finally, we use a LangChain wrapper to connect to the index to unify the workflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vector_store</span> <span class="o">=</span> <span class="n">QdrantVectorStore</span><span class="p">(</span>
    <span class="n">client</span><span class="o">=</span><span class="n">qd_client</span><span class="p">,</span>
    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
    <span class="n">embedding</span><span class="o">=</span><span class="n">embeddings</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to add our chunks to the vector storage. As we will be adding the chunks, the index will take care about converting our passages into embeddings.</p>
<p>In order to be able to delete / modify the chunks afterwards, we assign them with unique ids that we generate dynamically.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">))]</span>
<span class="n">vector_store</span><span class="o">.</span><span class="n">add_documents</span><span class="p">(</span>
    <span class="n">docs</span><span class="p">,</span>
    <span class="n">ids</span><span class="o">=</span><span class="n">ids</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;dc3efad1-1fbe-47f0-84ae-572108e29e7d&#39;,
 &#39;4da1cb73-104b-40a9-957f-d2f34c3b92bb&#39;,
 &#39;a701dd64-ab8f-43be-9989-9202a707569e&#39;,
 &#39;d2ccaff0-9bcf-4bfb-ad1f-2b514c36f24a&#39;,
 &#39;5e4330b9-b528-43ed-8aaf-f473a1197d41&#39;,
 &#39;319595a2-8b94-46b6-af2f-f7270dc75797&#39;,
 &#39;edb696e6-0896-4c9e-bb8b-917ee2fb9384&#39;,
 &#39;1919b71b-ece2-4afa-bffd-b5c2acb5b990&#39;,
 &#39;16f6dd91-f7c0-45b3-90ab-5ea80304cbbb&#39;,
 &#39;cca9b313-f03f-4958-95ea-e4901c8791ef&#39;,
 &#39;69a8ba48-f929-41aa-903c-30506d4830ae&#39;,
 &#39;40d1d663-dbc7-4a50-ba41-c8f7d95dee3f&#39;,
 &#39;16a583de-efbf-4cce-9004-adcc6c01c2e1&#39;,
 &#39;58833b28-6d22-4bff-9ce4-204a0574179d&#39;,
 &#39;04c75b55-48fe-4d5a-b3db-0d95805f9eec&#39;,
 &#39;3251fe14-6aa1-4f6b-a503-8d19097bae55&#39;,
 &#39;9c32a890-31c7-44cb-b83c-a8d9ed58627d&#39;,
 &#39;f9710b49-414b-42c8-b600-0c8ac710c730&#39;,
 &#39;5edddf55-11e9-4ca3-aded-9509fdf8c366&#39;,
 &#39;f88ed2b8-62fa-42cc-a60a-5453ef1b12e3&#39;,
 &#39;eaea295b-7f5b-4d35-a3e0-87b8804b3014&#39;,
 &#39;c6d12b7a-0659-404b-a960-698f802806b2&#39;,
 &#39;d6cfd473-6636-4ded-aaae-b077e7adfe53&#39;,
 &#39;2b7af95c-30d6-4554-bcf0-1ac2ad26f109&#39;,
 &#39;37dda168-fa33-4102-a8f6-da25786542f7&#39;,
 &#39;2c590d2f-bf19-4462-a400-e5b9d8ff5ff6&#39;,
 &#39;01c90ac4-3541-4630-bb9d-c82dc3022751&#39;,
 &#39;f0891052-0d8d-4c73-8a07-2134d7f1117a&#39;,
 &#39;b70709b1-6a91-4bef-ba4b-a030888511aa&#39;,
 &#39;c1c23ab4-a5b6-4a92-a178-dd7b95fa9233&#39;,
 &#39;6035c5f3-5c0c-4b7d-81df-ab380b549617&#39;,
 &#39;c0f77e55-308e-4637-a924-53ca6a9288a9&#39;,
 &#39;0ff27ae8-cffc-4aba-ba54-fcd320ab7786&#39;,
 &#39;bb8a886c-8165-4089-8cdc-3a48a45c5686&#39;,
 &#39;c052ee88-15c8-480b-b9a7-a3e971531e23&#39;,
 &#39;f1ec66e1-bab3-4735-9636-e69bc64b0c3e&#39;,
 &#39;9b828ea9-a300-48da-b408-76ce2b440e56&#39;,
 &#39;875d1724-816c-4571-a454-1480fdc6129d&#39;,
 &#39;2dd649b8-f5e7-4a4d-ac83-f905250a9fb8&#39;,
 &#39;dd347332-4eb2-44c2-ad53-d5d15b88757f&#39;,
 &#39;a1845151-affa-4aaa-b49c-dd665d47cf83&#39;,
 &#39;6cf565cb-b42a-4963-b224-a5eb5ae2f451&#39;,
 &#39;d7dd7d8c-4c84-495b-bf87-998875b3384a&#39;,
 &#39;c612e383-7b44-4d10-9d9b-a57cf06a1a47&#39;,
 &#39;7214d973-f923-4cfd-b2a4-c7212967c9e7&#39;,
 &#39;3c0eed46-e94a-43cf-a27d-a19b11adb900&#39;,
 &#39;8880f1ad-6eba-410e-914e-17c17c2d9536&#39;,
 &#39;9e4387bc-c6a0-4293-87c1-69b85cb2c32c&#39;,
 &#39;e15d69b5-d34a-4265-8e21-a2f8faea079d&#39;,
 &#39;1e57614b-40d1-41a9-9c2e-927593e25366&#39;,
 &#39;6f45ca4e-fef8-4b6e-ba51-30f2b4549c43&#39;,
 &#39;fa863a7c-c98b-4b90-844e-e547ba1c52cc&#39;,
 &#39;aec6a1fb-03db-4a60-9dd7-36a221f0ca94&#39;,
 &#39;1062b819-2e5f-4241-8bea-3fc947da23ee&#39;,
 &#39;8649431e-6e74-4a80-9367-02d417033f56&#39;,
 &#39;a5f49879-42f5-460a-85b8-ef3ea3ee5526&#39;,
 &#39;83ce75f5-31c8-456e-96ac-6ff988a754dd&#39;,
 &#39;31ec3f72-9108-4009-b346-15bce16e8b6c&#39;,
 &#39;02d9f436-d38c-4eef-a172-ac1268510a82&#39;,
 &#39;2ed2dd03-37f7-4cf5-b48c-87ea0974c4c6&#39;,
 &#39;512a67b3-eb71-41b5-b175-cf2a48ef7fac&#39;,
 &#39;d163946f-0f4f-4ea7-8321-dac9f1772c7f&#39;,
 &#39;76d3750d-f292-42a6-bfcd-1bd457252669&#39;,
 &#39;ae00b2a1-f477-41c4-9daa-3d9b20c57eed&#39;,
 &#39;8c97e4a1-4134-4a75-92b6-d073738183d4&#39;,
 &#39;be75d5f2-4b0b-41d5-8175-62a590fbde48&#39;]
</pre></div>
</div>
</div>
</div>
<h2 id="rag">2. Simple RAG 💉</h2>
<p>The basic RAG workflow is pretty straightforward: we just retrieve <em>k</em> most relevant documents and them insert them into the prompt as a part of the context.</p>
<p>For that, we will combine the skills we have obtained so far to build a LangGraph agent that receives the input, checks if the user wants to quit, then do the retrieval and generate a context-aware response if not. We will build on the basic version of our first chatbot; to add the RAG functionality, we need to add a retrieval node and modify the generation prompt to inject the retrieved documents.</p>
<p>First, we need to initialize our LLM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatPromptTemplate</span><span class="p">,</span> <span class="n">MessagesPlaceholder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.tools.retriever</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_retriever_tool</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># role: restrict it from the parametric knowledge</span>
<span class="n">basic_rag_system_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">You are an assistant that has access to a knowledge base. </span><span class="se">\</span>
<span class="s2">You should use the knowledge base to answer the user&#39;s questions.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># this will add the context to the input</span>
<span class="n">context_injection_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The user is asking a question. </span><span class="se">\</span>
<span class="s2">You should answer using the following context:</span>

<span class="s2">==========================</span>
<span class="si">{context}</span>
<span class="s2">==========================</span>


<span class="s2">The user question is:</span>
<span class="si">{input}</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># finally, gather the system message, the previous messages,</span>
<span class="c1"># and the input with the context</span>
<span class="n">basic_rag_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">basic_rag_system_prompt</span><span class="p">),</span>   <span class="c1"># system message</span>
        <span class="n">MessagesPlaceholder</span><span class="p">(</span><span class="n">variable_name</span><span class="o">=</span><span class="s2">&quot;messages&quot;</span><span class="p">),</span>  <span class="c1"># previous messages</span>
        <span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">context_injection_prompt</span><span class="p">)</span>  <span class="c1"># user message</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>LangGraph provides a pre-built tool to conveniently create a retriever tool. As this is basic RAG, we don’t generate queries for the retriever for now and just use the user input as the query.</p>
<p>Also, we will create a new simpler state because we won’t be using the <code class="docutils literal notranslate"><span class="pre">n_turns</span></code> and <code class="docutils literal notranslate"><span class="pre">language</span></code> properties.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BasicRAGChatbot</span><span class="p">(</span><span class="n">Chatbot</span><span class="p">):</span>

    <span class="n">_graph_path</span> <span class="o">=</span> <span class="s2">&quot;./graph_basic_rag.png&quot;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic_rag_prompt</span> <span class="o">=</span> <span class="n">basic_rag_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span> <span class="o">=</span> <span class="n">vector_store</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(</span><span class="n">search_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">})</span>    <span class="c1"># retrieve 5 documents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retriever_tool</span> <span class="o">=</span> <span class="n">create_retriever_tool</span><span class="p">(</span>    <span class="c1"># and this is the tool</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span><span class="p">,</span>
            <span class="s2">&quot;retrieve_internal_data&quot;</span><span class="p">,</span>  <span class="c1"># name</span>
            <span class="s2">&quot;Search relevant information in internal documents.&quot;</span><span class="p">,</span>   <span class="c1"># description</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># graph builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">SimpleState</span><span class="p">)</span>
        <span class="c1"># add the nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;retrieve&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_respond_node</span><span class="p">)</span>
        <span class="c1"># define edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="c1"># basic rag: no planning, just always retrieve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_quitting_node</span><span class="p">,</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;retrieve&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="n">END</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;retrieve&quot;</span><span class="p">,</span> <span class="s2">&quot;respond&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="c1"># compile the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_input_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SimpleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">user_query</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Your message: &quot;</span><span class="p">)</span>
        <span class="n">human_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">user_query</span><span class="p">)</span>
        <span class="c1"># add the input to the messages</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">human_message</span>   <span class="c1"># this will append the input to the messages</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_retrieve_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SimpleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># retrieve the context</span>
        <span class="n">user_query</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>  <span class="c1"># use the last message as the query</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retriever_tool</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">user_query</span><span class="p">})</span>
        <span class="c1"># add the context to the messages</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">context</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_respond_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SimpleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># the workflow is designed so that the context is always the last message</span>
        <span class="c1"># and the user query is the second to last message;</span>
        <span class="c1"># finally, we will be combining the context and the user query</span>
        <span class="c1"># into a single message so we remove those two from the messages</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
        <span class="n">user_query</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_rag_prompt</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">],</span>  <span class="c1"># this goes to the message placeholder</span>
                <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>  <span class="c1"># this goes to the user message</span>
                <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">user_query</span>    <span class="c1"># this goes to the user message</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="c1"># add the response to the messages</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">response</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
                <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">basic_rag_chatbot</span> <span class="o">=</span> <span class="n">BasicRAGChatbot</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
	- Avoid using `tokenizers` before the fork if possible
	- Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">basic_rag_chatbot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

what sessions do I have about virtual assistants?


================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

Adaptive RAG, LangGraph
Multimodality, LangChain
Week 520.05. Lecture: Virtual Assistants Pt. 3: Multi-agent EnvironmentThis lectures concludes the Virtual Assistants cycle and directs its attention to automating everyday /business operations in a multi-agent environment. We’ll look at how agents communicate with eachother, how their communication can be guided (both with and without involvement of a human), andthis all is used in real applications.
Key points:
Multi-agent environment
Human in the loop

Prompt Templates, LangChain
Few-shot prompting, LangChain
Week 413.05. Lecture: Virtual Assistants Pt. 2: RAGContinuing the first part, the second part will expand scope of chatbot functionality and will teach it torefer to custom knowledge base to retrieve and use user-specific information. Finally, the most widelyused deployment methods will be briefly introduced.
Key points:
General knowledge vs context
Knowledge indexing, retrieval &amp; ranking
Retrieval tools
Agentic RAG
Core Reading:

01.05.Ausfalltermin
Block 2: Core T opics
Part 1: Business ApplicationsWeek 306.05. Lecture: Virtual Assistants Pt. 1: ChatbotsThe first core topic concerns chatbots. We’ll discuss how chatbots are built, how they (should) handleharmful requests and you can tune it for your use case.
Key points:
LLMs alignment
Memory
Prompting &amp; automated prompt generation
Evaluation
Core Reading:
 Aligning Large Language Models with Human: A Survey (pages 1-14), Huawei Noah’s Ark Lab

12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 8 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
Week 8: Having Some Rest10.06.Ausfalltermin
12.06.Ausfalltermin
Week 917.06. Pitch: RAG Chatbot
On material of session 06.05 and session 13.05

Built with LangGraph, LangGraph (website page)
Plan-Then-Execute: An Empirical Study of User Trust and Team Performance When Using LLMAgents As A Daily Assistant, Delft University of Technology &amp; The University of Queensland
22.05. Lab: Multi-agent Environment
On material of session 20.05


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

You have three sessions about Virtual Assistants:

1. Week 3: Lecture: Virtual Assistants Pt. 1: Chatbots (06.05)
2. Week 4: Lecture: Virtual Assistants Pt. 2: RAG (13.05)
3. Week 5: Lecture: Virtual Assistants Pt. 3: Multi-agent Environment (20.05)

Additionally, you have a pitch session on RAG Chatbot in Week 9 (17.06) and a lab session on Multi-agent Environment (22.05) that build upon the material of these lectures.


================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

what are their dates?


================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

Disclaimer: the reading entries are no proper citations; the bibtex references as well as detailed infosabout the authors, publish date etc. can be found under the entry links.

12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 8 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
Week 8: Having Some Rest10.06.Ausfalltermin
12.06.Ausfalltermin
Week 917.06. Pitch: RAG Chatbot
On material of session 06.05 and session 13.05

12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 1 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
To p i c s  O v e r v i e wThe schedule is preliminary and subject to changes!
The reading for each lecture is given as references to the sources the respective lectures base on. Youare not obliged to read anything. However, you are strongly encouraged to read references marked bypin emojis

On material of session 01.07
The last pitch will introduce an agent that will have to plan the research, generate hypotheses, find theliterature etc. for a given scientific problem. It will then have to introduce its results in form of a TODOor a guide for the researcher to start off of. Specific requirements will be released on 01.07.
Reading: see session 01.07 and session 03.07
24.07. Debate: Role of AI in Recent Years + Wrap-up
On material of session 17.07

On material of session 06.05 and session 13.05
The first pitch will be dedicated to a custom RAG chatbot that the contractors (the presentingstudents, see the infos about Pitches) will have prepared to present. The RAG chatbot will have to beable to retrieve specific information from the given documents (not from the general knowledge!) anduse it in its responses. Specific requirements will be released on 22.05.
Reading: see session 06.05, session 08.05, session 13.05, and session 15.05
19.06.Ausfalltermin


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

Based on the provided context, the dates mentioned are:

1. 06.05 (session on Virtual Assistants Pt. 1: Chatbots)
2. 13.05 (session on Virtual Assistants Pt. 2: RAG)
3. 17.06 (Pitch: RAG Chatbot)
4. 01.07 (session with specific requirements for the last pitch)
5. 03.07 (session related to the last pitch)
6. 17.07 (session related to the debate on the Role of AI in Recent Years)
7. 22.05 (release of specific requirements for the RAG chatbot)
8. 24.07 (Debate: Role of AI in Recent Years + Wrap-up)
9. 10.06 (Ausfalltermin)
10. 12.06 (Ausfalltermin)
11. 19.06 (Ausfalltermin) 
12. 12.05.25 (Topics Overview - LLM-based Assistants) 
13. 08.05 (session related to the RAG chatbot)
14. 15.05 (session related to the RAG chatbot)


================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

quit
</pre></div>
</div>
</div>
</div>
<p>As you can see, it already works pretty well, but as the retrieval goes by the user query directly, all the previous context of the conversation is not considered. To handle that, let’s add a node that would reformulate the query taking in consideration the previous interaction.</p>
<p>For that, we need an additional prompt.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># finally, gather the system message, the previous messages,</span>
<span class="c1"># and the input with the context</span>
<span class="n">reformulate_query_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;system&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Given the previous conversation, reformulate the user query in the last message to a full question. &quot;</span>
            <span class="s2">&quot;Return only the reformulated query, without any other text.&quot;</span>
        <span class="p">),</span>   <span class="c1"># system message</span>
        <span class="n">MessagesPlaceholder</span><span class="p">(</span><span class="n">variable_name</span><span class="o">=</span><span class="s2">&quot;messages&quot;</span><span class="p">)</span>  <span class="c1"># previous messages</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BasicPlusRAGChatbot</span><span class="p">(</span><span class="n">BasicRAGChatbot</span><span class="p">):</span>

    <span class="n">_graph_path</span> <span class="o">=</span> <span class="s2">&quot;./graph_basic_plus_rag.png&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reformulate_query_prompt</span> <span class="o">=</span> <span class="n">reformulate_query_prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># graph builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">SimpleState</span><span class="p">)</span>
        <span class="c1"># add the nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;reformulate_query&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reformulate_query_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;retrieve&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_respond_node</span><span class="p">)</span>
        <span class="c1"># define edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="c1"># basic rag: no planning, just always retrieve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_quitting_node</span><span class="p">,</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;reformulate_query&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="n">END</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;reformulate_query&quot;</span><span class="p">,</span> <span class="s2">&quot;retrieve&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;retrieve&quot;</span><span class="p">,</span> <span class="s2">&quot;respond&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="c1"># compile the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reformulate_query_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SimpleState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reformulate_query_prompt</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">generated_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="c1"># since we use the generated query instead of the user query,</span>
        <span class="c1"># we need to remove the user query from the messages</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">generated_query</span> <span class="c1"># append the generated query to the messages</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">basic_plus_rag_chatbot</span> <span class="o">=</span> <span class="n">BasicPlusRAGChatbot</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">basic_plus_rag_chatbot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

what sessions do I have about virtual assistants?


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

What sessions do I have scheduled that are related to virtual assistants?


================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 8 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
Week 8: Having Some Rest10.06.Ausfalltermin
12.06.Ausfalltermin
Week 917.06. Pitch: RAG Chatbot
On material of session 06.05 and session 13.05

Adaptive RAG, LangGraph
Multimodality, LangChain
Week 520.05. Lecture: Virtual Assistants Pt. 3: Multi-agent EnvironmentThis lectures concludes the Virtual Assistants cycle and directs its attention to automating everyday /business operations in a multi-agent environment. We’ll look at how agents communicate with eachother, how their communication can be guided (both with and without involvement of a human), andthis all is used in real applications.
Key points:
Multi-agent environment
Human in the loop

01.05.Ausfalltermin
Block 2: Core T opics
Part 1: Business ApplicationsWeek 306.05. Lecture: Virtual Assistants Pt. 1: ChatbotsThe first core topic concerns chatbots. We’ll discuss how chatbots are built, how they (should) handleharmful requests and you can tune it for your use case.
Key points:
LLMs alignment
Memory
Prompting &amp; automated prompt generation
Evaluation
Core Reading:
 Aligning Large Language Models with Human: A Survey (pages 1-14), Huawei Noah’s Ark Lab

12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 6 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
This lab will introduce a short walkthrough to creation of a multi-agent environment for automatedmeeting scheduling and preparation. We will see how the coordinator agent will communicate with twoauxiliary agents to check time availability and prepare an agenda for the meeting.
Reading:
 Multi-agent network, LangGraph
 Human-in-the-loop, LangGraph

On material of session 20.05
In the second pitch, the contractors will present their solution to automated handling of customerrequests. The solution will have to introduce a multi-agent environment to take off working load froman imagined support team. The solution will have to read and categorize tickets, generate replies and(in case of need) notify the human that their interference is required. Specific requirements will bereleased on 27.05.
Reading: see session 20.05 and session 22.05


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

Based on the provided context, you have the following sessions related to virtual assistants:

1. Week 3: 06.05 - Lecture: Virtual Assistants Pt. 1: Chatbots
2. Week 5: 20.05 - Lecture: Virtual Assistants Pt. 3: Multi-agent Environment
3. Week 9: 17.06 - Pitch: RAG Chatbot (related to material from sessions 06.05 and 13.05)

These sessions cover topics such as chatbots, multi-agent environments, and human-in-the-loop systems, all of which are related to virtual assistants.


================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

what are their dates?


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

What are the dates of the sessions related to virtual assistants?


================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

On material of session 20.05
In the second pitch, the contractors will present their solution to automated handling of customerrequests. The solution will have to introduce a multi-agent environment to take off working load froman imagined support team. The solution will have to read and categorize tickets, generate replies and(in case of need) notify the human that their interference is required. Specific requirements will bereleased on 27.05.
Reading: see session 20.05 and session 22.05

12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 8 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
Week 8: Having Some Rest10.06.Ausfalltermin
12.06.Ausfalltermin
Week 917.06. Pitch: RAG Chatbot
On material of session 06.05 and session 13.05

01.05.Ausfalltermin
Block 2: Core T opics
Part 1: Business ApplicationsWeek 306.05. Lecture: Virtual Assistants Pt. 1: ChatbotsThe first core topic concerns chatbots. We’ll discuss how chatbots are built, how they (should) handleharmful requests and you can tune it for your use case.
Key points:
LLMs alignment
Memory
Prompting &amp; automated prompt generation
Evaluation
Core Reading:
 Aligning Large Language Models with Human: A Survey (pages 1-14), Huawei Noah’s Ark Lab

12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 6 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
This lab will introduce a short walkthrough to creation of a multi-agent environment for automatedmeeting scheduling and preparation. We will see how the coordinator agent will communicate with twoauxiliary agents to check time availability and prepare an agenda for the meeting.
Reading:
 Multi-agent network, LangGraph
 Human-in-the-loop, LangGraph

Adaptive RAG, LangGraph
Multimodality, LangChain
Week 520.05. Lecture: Virtual Assistants Pt. 3: Multi-agent EnvironmentThis lectures concludes the Virtual Assistants cycle and directs its attention to automating everyday /business operations in a multi-agent environment. We’ll look at how agents communicate with eachother, how their communication can be guided (both with and without involvement of a human), andthis all is used in real applications.
Key points:
Multi-agent environment
Human in the loop


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

Based on the provided context, the dates of the sessions related to virtual assistants are:

1. Week 3: 06.05 - Lecture: Virtual Assistants Pt. 1: Chatbots
2. Week 5: 20.05 - Lecture: Virtual Assistants Pt. 3: Multi-agent Environment
3. Week 9: 17.06 - Pitch: RAG Chatbot (related to material from sessions 06.05 and 13.05)

So, the dates are: 
- 06.05
- 20.05
- 17.06


================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

quit
</pre></div>
</div>
</div>
</div>
<h2 id="adv_rag">3. Advanced RAG 😎</h2>
<p>Now we can move to a more complicated implementation. We will no make an iterative RAG chatbot: this chatbot will retrieve contexts iteratively and decide at each step whether the chunks retrieved so far are sufficient to answer the question; the answer is generated only when the retrieved contexts are enough.</p>
<p>Basically, we have almost everything we need to implement an iterative RAG pipeline. We only need to add three more nodes:</p>
<ol class="arabic simple">
<li><p>A node to generate search queries for the index: now we won’t use the user query but specifically generate queries for the index.</p></li>
<li><p>A decision node, in which the LLM will decide whether the context retrieved so far is enough to proceed to generation of the response.</p></li>
<li><p>Query transformer that will reformulate the query to retrieve further chunks when it’s needed.</p></li>
</ol>
<p>As a useful addition, we will also add LLM-based filtering of the retrieved documents to filter out the documents that are semantically similar to the query but are not really relevant for answering the question.</p>
<p>Thus, we need to add 4 nodes totally.</p>
<p>We will start with the grader that will output a binary score for the relevance: <code class="docutils literal notranslate"><span class="pre">True</span></code>(relevant) or <code class="docutils literal notranslate"><span class="pre">False</span></code> (irrelevant). To implement this functionality, we’ll bind the LLM to a true/false structured output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">YesNoVerdict</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">verdict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Boolean answer to the given binary question.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will also need to transform the state to accumulate the contexts gathered so far.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdvancedRAGState</span><span class="p">(</span><span class="n">SimpleState</span><span class="p">):</span> <span class="c1"># &quot;messages&quot; is already defined in SimpleRAGState</span>
    <span class="n">contexts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]]</span>    <span class="c1"># this is the list of retrieved documents, one list per retrieval</span>
</pre></div>
</div>
</div>
</div>
<p>And we also need prompts to filter the documents, to decide whether the contexts are supportive enough, and to transform the query if not.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">generate_query_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The user is asking a question. </span><span class="se">\</span>
<span class="s2">You have an access to a knowledge base. </span><span class="se">\</span>
<span class="s2">Your task is to generate a query that will retrieve the most relevant documents </span><span class="se">\</span>
<span class="s2">from the knowledge base to answer the user question. </span><span class="se">\</span>
<span class="s2">Return the query only, without any other text.</span>


<span class="s2">The user question is:</span>
<span class="si">{input}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">generate_query_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">generate_query_template</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">context_relevant_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The user is asking a question. </span><span class="se">\</span>
<span class="s2">For answering the question, you colleague have retrieved the following document:</span>


<span class="s2">===========================</span>
<span class="si">{context}</span>
<span class="s2">===========================</span>


<span class="s2">You task is to assess whether this document is relevant to answer the user question. </span><span class="se">\</span>
<span class="s2">Relevant means that the document contains specific information should be used </span><span class="se">\</span>
<span class="s2">directly to answer the user question. </span><span class="se">\</span>
<span class="s2">Return True if the document is relevant, and False otherwise.</span>


<span class="s2">The user question is:</span>
<span class="si">{input}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">context_relevant_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">context_relevant_template</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contexts_sufficient_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The user is asking a question. </span><span class="se">\</span>

<span class="s2">For answering the question, you colleague have retrieved the following document:</span>


<span class="s2">===========================</span>
<span class="si">{contexts_str}</span>
<span class="s2">===========================</span>


<span class="s2">You task is to assess whether the retrieved documents contain an answer the user question. </span><span class="se">\</span>
<span class="s2">Return True if the documents are sufficient, and False otherwise.</span>


<span class="s2">The user question is:</span>
<span class="si">{input}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">contexts_sufficient_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">contexts_sufficient_template</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transform_query_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">The user is asking a question. </span><span class="se">\</span>

<span class="s2">For answering the question, your colleague the following document has been retrieved:</span>


<span class="s2">===========================</span>
<span class="si">{contexts_str}</span>
<span class="s2">===========================</span>


<span class="s2">To retrieve these documents, the following query has been used:</span>
<span class="si">{query}</span>


<span class="s2">However, the query is not very good so the retrieved documents were not helpful. </span><span class="se">\</span>
<span class="s2">Your task is to transform the query into a better one, so that the retrieved documents are more relevant. </span><span class="se">\</span>
<span class="s2">Return the transformed query only, without any other text.</span>


<span class="s2">The user question is:</span>
<span class="si">{input}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">transform_query_prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">transform_query_template</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IterativeRAGChatbot</span><span class="p">(</span><span class="n">BasicPlusRAGChatbot</span><span class="p">):</span>

    <span class="n">_graph_path</span> <span class="o">=</span> <span class="s2">&quot;./graph_iterative_rag.png&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_generations</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_generations</span> <span class="o">=</span> <span class="n">max_generations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boolean_llm</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">YesNoVerdict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_query_prompt</span> <span class="o">=</span> <span class="n">generate_query_prompt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_relevant_grader</span> <span class="o">=</span> <span class="n">context_relevant_prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolean_llm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contexts_sufficient_grader</span> <span class="o">=</span> <span class="n">contexts_sufficient_prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolean_llm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_query_prompt</span> <span class="o">=</span> <span class="n">transform_query_prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># graph builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AdvancedRAGState</span><span class="p">)</span>
        <span class="c1"># add the nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;reformulate_query&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reformulate_query_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;generate_query&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;retrieve&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;filter_documents&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_documents_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;transform_query&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_query_node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_respond_node</span><span class="p">)</span>
        <span class="c1"># define edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="c1"># basic rag: no planning, just always retrieve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_quitting_node</span><span class="p">,</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;reformulate_query&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="n">END</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;reformulate_query&quot;</span><span class="p">,</span> <span class="s2">&quot;generate_query&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;generate_query&quot;</span><span class="p">,</span> <span class="s2">&quot;retrieve&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;retrieve&quot;</span><span class="p">,</span> <span class="s2">&quot;filter_documents&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
            <span class="s2">&quot;filter_documents&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_contexts_sufficient_node</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;transform_query&quot;</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;respond&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">:</span> <span class="n">END</span>   <span class="c1"># max generations reached</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;transform_query&quot;</span><span class="p">,</span> <span class="s2">&quot;retrieve&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_graph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;respond&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">)</span>
        <span class="c1"># compile the graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compile</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_query_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AdvancedRAGState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>    
        <span class="n">user_query</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>  <span class="c1"># that will be the reformulated user query</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">generate_query_prompt</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">user_query</span><span class="p">})</span>
        <span class="n">search_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">search_query</span>
        <span class="p">}</span>

    <span class="c1"># now store the contexts in the separate field</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_retrieve_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AdvancedRAGState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>    
        <span class="c1"># retrieve the context</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>  <span class="c1"># that will be the generated query</span>
        <span class="c1"># now use the retriever directly to get a list of documents and not a combined string</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retriever</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="c1"># add the context to the messages</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;contexts&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;contexts&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">contexts</span><span class="p">]</span>  <span class="c1"># could have also used `Annotated` here</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_documents_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AdvancedRAGState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>  <span class="c1"># that will be the generated query</span>
        <span class="c1"># since the retrieved documents are graded at the same step,</span>
        <span class="c1"># we only need to pass the last batch of documents</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;contexts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># will be replaced with the filtered ones</span>
        <span class="c1"># grade each document separately and only keep the relevant ones</span>
        <span class="n">relevant_contexts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">contexts</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Grading document:</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">page_content</span><span class="p">)</span>
            <span class="n">verdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_relevant_grader</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">page_content</span><span class="p">,</span>    <span class="c1"># this is a Document object</span>
                    <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">query</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verdict: </span><span class="si">{</span><span class="n">verdict</span><span class="o">.</span><span class="n">verdict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">=====================</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verdict</span><span class="o">.</span><span class="n">verdict</span><span class="p">:</span>    <span class="c1"># boolean value according to the Pydantic model</span>
                <span class="n">relevant_contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;contexts&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;contexts&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">relevant_contexts</span><span class="p">]</span>  <span class="c1"># could have also used `Annotated` here</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_contexts_sufficient_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AdvancedRAGState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>   <span class="c1"># that will be the reformulated user query, -1 is the generated search query</span>
        <span class="n">all_contexts</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;contexts&quot;</span><span class="p">]</span>
        <span class="c1"># flatten and transform the list of lists into a single list</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">all_contexts</span> <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">contexts_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">context</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">contexts</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deciding whether the documents are sufficient&quot;</span><span class="p">)</span>
        <span class="n">verdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contexts_sufficient_grader</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
                <span class="p">{</span>
                <span class="s2">&quot;contexts_str&quot;</span><span class="p">:</span> <span class="n">contexts_str</span><span class="p">,</span>    <span class="c1"># this is a Document object</span>
                <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">query</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Verdict: </span><span class="si">{</span><span class="n">verdict</span><span class="o">.</span><span class="n">verdict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">=====================</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verdict</span><span class="o">.</span><span class="n">verdict</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_contexts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_generations</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># will route to END</span>
        <span class="k">return</span> <span class="n">verdict</span><span class="o">.</span><span class="n">verdict</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_transform_query_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AdvancedRAGState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># since we will be replacing the user query with the transformed one,</span>
        <span class="c1"># we need to remove the old query</span>
        <span class="n">search_query</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>   <span class="c1"># this is the generated search query</span>
        <span class="c1"># the the reformulated user query is the last message</span>
        <span class="n">user_query</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span>
        <span class="n">all_contexts</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;contexts&quot;</span><span class="p">]</span>
        <span class="c1"># flatten and transform the list of lists into a single list</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">all_contexts</span> <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">contexts_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">context</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">context</span> <span class="ow">in</span> <span class="n">contexts</span><span class="p">])</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_query_prompt</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;contexts_str&quot;</span><span class="p">:</span> <span class="n">contexts_str</span><span class="p">,</span>
                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">search_query</span><span class="p">,</span>
                <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="n">user_query</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">transformed_search_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">transformed_search_query</span>   <span class="c1"># this will append the transformed query to the messages</span>
        <span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;contexts&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;suka&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatbot</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
                <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make small k to ensure one retrieval is not enough</span>
<span class="n">iterative_rag_chatbot</span> <span class="o">=</span> <span class="n">IterativeRAGChatbot</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iterative_rag_chatbot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================<span class=" -Color -Color-Bold"> Human Message </span>=================================

what are the key point of the next lecture after the one on 13.05


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

What are the key points of the next lecture after the one on May 13th?


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

lecture after May 13th key points


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

lecture after May 13th key points


Grading document:

 12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 1 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
To p i c s  O v e r v i e wThe schedule is preliminary and subject to changes!
The reading for each lecture is given as references to the sources the respective lectures base on. Youare not obliged to read anything. However, you are strongly encouraged to read references marked bypin emojis
Verdict: False


=====================


Grading document:

 12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 7 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
Week 703.06. Lecture: Software Development Pt. 2: Copilots, LLM-powered WebsitesThe second and the last lecture of the software development cycle focuses on practical application ofLLM code generation, in particular, on widely-used copilots (real-time code generation assistants) andLLM-supported web development.
Key points:
Copilots &amp; real-time hints
Verdict: True


=====================


Deciding whether the documents are sufficient
Verdict: False


=====================


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

lecture after May 13th key points


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

next lecture after May 13th key points summary


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

next lecture after May 13th key points summary


Grading document:

 12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 1 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
To p i c s  O v e r v i e wThe schedule is preliminary and subject to changes!
The reading for each lecture is given as references to the sources the respective lectures base on. Youare not obliged to read anything. However, you are strongly encouraged to read references marked bypin emojis
Verdict: False


=====================


Grading document:

 On material of session 17.07
The course will be concluded by the final debates, after which a short Q&amp;A session will be held.
Debate topics:
LLM Behavior: Evidence of Awareness or Illusion of Understanding?
Should We Limit the Usage of AI?
Reading: see session 17.07
Copyright © 2025, Maksim ShmaltsMade with Sphinx and @pradyunsg&#39;s Furo
Verdict: False


=====================


Deciding whether the documents are sufficient
Verdict: False


=====================


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

next lecture after May 13th key points summary


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

lecture key points after May 13th summary


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

lecture key points after May 13th summary


Grading document:

 12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 1 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
To p i c s  O v e r v i e wThe schedule is preliminary and subject to changes!
The reading for each lecture is given as references to the sources the respective lectures base on. Youare not obliged to read anything. However, you are strongly encouraged to read references marked bypin emojis
Verdict: False


=====================


Grading document:

 12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 7 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
Week 703.06. Lecture: Software Development Pt. 2: Copilots, LLM-powered WebsitesThe second and the last lecture of the software development cycle focuses on practical application ofLLM code generation, in particular, on widely-used copilots (real-time code generation assistants) andLLM-supported web development.
Key points:
Copilots &amp; real-time hints
Verdict: True


=====================


Deciding whether the documents are sufficient
Verdict: False


=====================


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

lecture key points after May 13th summary


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

next lecture key points after May 13th summary


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

next lecture key points after May 13th summary


Grading document:

 12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 1 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
To p i c s  O v e r v i e wThe schedule is preliminary and subject to changes!
The reading for each lecture is given as references to the sources the respective lectures base on. Youare not obliged to read anything. However, you are strongly encouraged to read references marked bypin emojis
Verdict: False


=====================


Grading document:

 12.05.25, 17:28Topics Overview - LLM-based Assistants
Page 7 of 12https://maxschmaltz.github.io/Course-LLM-based-Assistants/infos/topic_overview.html
Week 703.06. Lecture: Software Development Pt. 2: Copilots, LLM-powered WebsitesThe second and the last lecture of the software development cycle focuses on practical application ofLLM code generation, in particular, on widely-used copilots (real-time code generation assistants) andLLM-supported web development.
Key points:
Copilots &amp; real-time hints
Verdict: True


=====================


Deciding whether the documents are sufficient
Verdict: False


=====================


==================================<span class=" -Color -Color-Bold"> Ai Message </span>==================================

next lecture key points after May 13th summary
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./sessions/block2_core_topics/pt1_business/2005"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../../pt2_science/under_development.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Under development</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../1505/1505.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">15.05. RAG Chatbot Pt. 1 📚</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Maksim Shmalts
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link footer-icon" href="https://github.com/maxschmaltz/Course-LLM-based-Assistants" aria-label="GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 18 18">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
</svg>
</a>
              <a class="muted-link footer-icon" href="https://github.com/maxschmaltz/Course-LLM-based-Assistants/issues/new" aria-label="Issues"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 18 18">
  <path d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
  <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm.1-6.995a.905.905 0 0 1 1.8 0l-.35 4.5a.55.55 0 0 1-1.1 0l-.35-4.5z"/>
</svg>
</a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">20.05. RAG Chatbot Pt. 2 📚</a><ul>
<li><a class="reference internal" href="#prerequisites">Prerequisites</a><ul>
<li><a class="reference internal" href="#loading">Loading</a></li>
<li><a class="reference internal" href="#chunking">Chunking</a></li>
<li><a class="reference internal" href="#convert-to-embeddings">Convert to Embeddings</a></li>
<li><a class="reference internal" href="#indexing">Indexing</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    </body>
</html>